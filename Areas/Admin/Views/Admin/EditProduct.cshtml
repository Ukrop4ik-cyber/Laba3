@using WebApplication2.Models
@model WebApplication2.Models.Product
@{
    ViewData["Title"] = "Редагувати товар";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

<div class="row">
    <div class="col-lg-8">
        <form method="post" enctype="multipart/form-data" asp-action="EditProduct">
            @Html.AntiForgeryToken()
            
            <!-- Приховані поля -->
            <input type="hidden" name="Id" value="@Model.Id" />
            <input type="hidden" name="CreatedAt" value="@Model.CreatedAt.ToString("yyyy-MM-ddTHH:mm:ss")" />
            <input type="hidden" name="ImageUrl" value="@Model.ImageUrl" />

            <!-- Основна інформація -->
            <div class="table-card mb-3">
                <h5 class="mb-3">Основна інформація</h5>

                <div class="mb-3">
                    <label asp-for="Name" class="form-label">Назва товару *</label>
                    <input asp-for="Name" name="Name" class="form-control" 
                           placeholder="Наприклад: ASUS ROG Strix G15" required
                           value="@Model.Name">
                    <span asp-validation-for="Name" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="Description" class="form-label">Опис *</label>
                    <textarea asp-for="Description" name="Description" class="form-control" rows="4" 
                              placeholder="Детальний опис товару" required>@Model.Description</textarea>
                    <span asp-validation-for="Description" class="text-danger"></span>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label asp-for="CategoryId" class="form-label">Категорія *</label>
                        <select asp-for="CategoryId" name="CategoryId" class="form-select" required>
                            <option value="">Оберіть категорію...</option>
                            @foreach (var cat in ViewBag.Categories as List<Category>)
                            {
                                <option value="@cat.Id" selected="@(cat.Id == Model.CategoryId)">@cat.Name</option>
                            }
                        </select>
                        <span asp-validation-for="CategoryId" class="text-danger"></span>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label asp-for="Brand" class="form-label">Бренд</label>
                        <input asp-for="Brand" name="Brand" class="form-control" list="brands" 
                               placeholder="Наприклад: ASUS" value="@Model.Brand">
                        <datalist id="brands">
                            <option value="ASUS">
                            <option value="Lenovo">
                            <option value="HP">
                            <option value="Dell">
                            <option value="Acer">
                            <option value="Apple">
                            <option value="MSI">
                            <option value="Logitech">
                        </datalist>
                        <span asp-validation-for="Brand" class="text-danger"></span>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label asp-for="Price" class="form-label">Ціна (грн) *</label>
                        <input asp-for="Price" name="Price" type="text" inputmode="decimal" 
                               class="form-control" placeholder="0,00" required
                               pattern="[0-9]+([\.,][0-9]{1,2})?" 
                               title="Введіть число з двома десятковими знаками">
                        <span asp-validation-for="Price" class="text-danger"></span>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label asp-for="StockQuantity" class="form-label">Кількість на складі *</label>
                        <input asp-for="StockQuantity" name="StockQuantity" type="number" min="0" 
                               class="form-control" placeholder="0" required
                               value="@Model.StockQuantity">
                        <span asp-validation-for="StockQuantity" class="text-danger"></span>
                    </div>
                </div>

                <div class="mb-3">
                    <div class="form-check">
                        @{
                            var isChecked = Model.IsAvailable ? "checked" : "";
                        }
                        <input asp-for="IsAvailable" name="IsAvailable" class="form-check-input" 
                               type="checkbox" value="true" @isChecked>
                        <input type="hidden" name="IsAvailable" value="false" />
                        <label asp-for="IsAvailable" class="form-check-label">
                            Доступний для продажу
                        </label>
                    </div>
                </div>
            </div>

            <!-- Зображення -->
            <div class="table-card mb-3">
                <h5 class="mb-3">Зображення товару</h5>

                <!-- Поточне зображення -->
                @if (!string.IsNullOrEmpty(Model.ImageUrl))
                {
                    <div class="mb-3">
                        <label class="form-label">Поточне зображення</label>
                        <div>
                            <img src="@Model.ImageUrl" alt="Поточне зображення" 
                                 class="img-thumbnail" style="max-width: 200px;">
                        </div>
                    </div>
                }

                <div class="mb-3">
                    <label for="image" class="form-label">Змінити зображення</label>
                    <input type="file" name="image" id="imageInput" class="form-control" 
                           accept="image/jpeg,image/jpg,image/png,image/gif,image/webp">
                    <small class="text-muted">Рекомендований розмір: 800x800px. Максимум: 5MB. Формати: JPG, PNG, GIF, WebP</small>
                </div>

                <div id="imagePreview" class="d-none mt-3">
                    <img id="preview" src="#" alt="Preview" class="img-thumbnail" style="max-width: 300px;">
                </div>
            </div>

            <!-- Характеристики -->
            <div class="table-card mb-3">
                <h5 class="mb-3">Характеристики (JSON)</h5>

                <div class="mb-3">
                    <textarea asp-for="Specifications" name="Specifications" class="form-control" rows="5" 
                              placeholder='{"cpu":"Intel Core i5","ram":"8GB","storage":"256GB SSD"}'>@Model.Specifications</textarea>
                    <small class="text-muted">
                        Формат JSON: {"ключ":"значення"}. Приклад:<br>
                        {"cpu":"Intel Core i7","ram":"16GB","storage":"512GB SSD","display":"15.6 FHD"}
                    </small>
                    <span asp-validation-for="Specifications" class="text-danger"></span>
                </div>
            </div>

            <!-- Кнопки -->
            <div class="d-flex gap-2 mb-4">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Оновити товар
                </button>
                <a asp-action="Products" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Скасувати
                </a>
            </div>
        </form>
    </div>

    <div class="col-lg-4">
        <!-- Підказки -->
        <div class="table-card">
            <h5 class="mb-3"><i class="fas fa-info-circle"></i> Підказки</h5>
            <ul class="small mb-0">
                <li>Поля позначені * є обов'язковими</li>
                <li>Назва має бути зрозумілою та описовою</li>
                <li>Додайте якісне фото товару (до 5MB)</li>
                <li>Вкажіть правильну категорію</li>
                <li>Характеристики у форматі JSON покращують SEO</li>
                <li>Перевірте ціну та кількість перед збереженням</li>
            </ul>
        </div>

        <div class="table-card mt-3 bg-light">
            <h6 class="mb-2"><i class="fas fa-exclamation-triangle text-warning"></i> Важливо</h6>
            <small>
                • Ціна вказується у гривнях<br>
                • Зображення має бути чітким<br>
                • Опис має бути інформативним
            </small>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // Попередній перегляд зображення
        document.getElementById('imageInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // Перевірка розміру
                if (file.size > 5 * 1024 * 1024) {
                    alert('Розмір файлу не повинен перевищувати 5MB');
                    this.value = '';
                    return;
                }
                
                // Перевірка типу
                const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
                if (!allowedTypes.includes(file.type)) {
                    alert('Дозволені тільки JPG, PNG, GIF та WebP файли');
                    this.value = '';
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    document.getElementById('preview').src = event.target.result;
                    document.getElementById('imagePreview').classList.remove('d-none');
                };
                reader.readAsDataURL(file);
            }
        });

        // Валідація JSON перед відправкою
        document.querySelector('form').addEventListener('submit', function(e) {
            const specificationsField = document.querySelector('[name="Specifications"]');
            if (specificationsField.value.trim()) {
                try {
                    JSON.parse(specificationsField.value);
                } catch (error) {
                    e.preventDefault();
                    alert('Помилка в форматі JSON характеристик. Перевірте правильність синтаксису.');
                    specificationsField.focus();
                    return false;
                }
            }
        });

        // Додаткова перевірка перед відправкою
        document.querySelector('form').addEventListener('submit', function(e) {
            console.log('=== Edit Form Submit Debug ===');
            const formData = new FormData(this);
            for (let pair of formData.entries()) {
                console.log(pair[0] + ': ' + pair[1]);
            }
        });
    </script>
}