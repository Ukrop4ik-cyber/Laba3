@using WebApplication2.Models
@model List<Product>
@{
    ViewData["Title"] = "Управління товарами";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

<div class="table-card">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4><i class="fas fa-box"></i> Товари (@Model.Count)</h4>
        <a href="/Admin/Admin/CreateProduct" class="btn btn-primary">
            <i class="fas fa-plus"></i> Додати товар
        </a>
    </div>

    <!-- Фільтри -->
    <form method="get" class="row g-3 mb-4">
        <div class="col-md-4">
            <input type="text" name="search" class="form-control" 
                   placeholder="Пошук..." value="@ViewBag.Search">
        </div>
        <div class="col-md-3">
            <select name="categoryId" class="form-select">
                <option value="">Всі категорії</option>
                @foreach (var cat in ViewBag.Categories as List<Category>)
                {
                    <option value="@cat.Id" selected="@(ViewBag.CategoryId == cat.Id)">
                        @cat.Name
                    </option>
                }
            </select>
        </div>
        <div class="col-md-5">
            <button type="submit" class="btn btn-primary w-100">
                <i class="fas fa-search"></i> Шукати
            </button>
        </div>
    </form>

    <!-- Масові дії -->
    <div id="bulkActionsPanel" class="alert alert-info d-none mb-3">
        <div class="d-flex gap-2">
            <button onclick="bulkAction('activate')" class="btn btn-sm btn-success">
                <i class="fas fa-check"></i> Активувати
            </button>
            <button onclick="bulkAction('deactivate')" class="btn btn-sm btn-warning">
                <i class="fas fa-ban"></i> Деактивувати
            </button>
            <button onclick="bulkAction('delete')" class="btn btn-sm btn-danger">
                <i class="fas fa-trash"></i> Видалити
            </button>
            <span class="ms-auto">
                Обрано: <strong id="selectedCount">0</strong>
            </span>
        </div>
    </div>

    <!-- Таблиця -->
    <div class="table-responsive">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th width="30">
                        <input type="checkbox" id="selectAll">
                    </th>
                    <th width="60">Фото</th>
                    <th>Назва</th>
                    <th>Категорія</th>
                    <th>Ціна</th>
                    <th>Залишок</th>
                    <th>Статус</th>
                    <th width="150">Дії</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var product in Model)
                {
                    <tr>
                        <td>
                            <input type="checkbox" class="product-checkbox" value="@product.Id">
                        </td>
                        <td>
                            <img src="@(product.ImageUrl ?? "/images/no-image.jpg")" 
                                 class="img-thumbnail" style="width:50px;height:50px;object-fit:cover">
                        </td>
                        <td>
                            <strong>@product.Name</strong>
                            <br>
                            <small class="text-muted">@product.Brand</small>
                        </td>
                        <td>@product.Category.Name</td>
                        <td><strong>@product.Price.ToString("N0") ₴</strong></td>
                        <td>
                            @if (product.StockQuantity < 10)
                            {
                                <span class="badge bg-danger">@product.StockQuantity</span>
                            }
                            else
                            {
                                <span class="badge bg-success">@product.StockQuantity</span>
                            }
                        </td>
                        <td>
                            @if (product.IsAvailable)
                            {
                                <span class="badge bg-success">Активний</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary">Неактивний</span>
                            }
                        </td>
                        <td>
                            <div class="btn-group">
                                <a href="/Admin/Admin/EditProduct/@product.Id" class="btn btn-sm btn-primary">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <button onclick="deleteProduct(@product.Id)" class="btn btn-sm btn-danger">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- Пагінація -->
    @if (ViewBag.TotalPages > 1)
    {
        <nav class="mt-3">
            <ul class="pagination justify-content-center">
                @for (int i = 1; i <= ViewBag.TotalPages; i++)
                {
                    <li class="page-item @(i == ViewBag.CurrentPage ? "active" : "")">
                        <a class="page-link" href="?page=@i&search=@ViewBag.Search&categoryId=@ViewBag.CategoryId">
                            @i
                        </a>
                    </li>
                }
            </ul>
        </nav>
    }
</div>

<script>
    document.getElementById('selectAll').addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.product-checkbox');
        checkboxes.forEach(cb => cb.checked = this.checked);
        updateSelectedCount();
    });

    document.querySelectorAll('.product-checkbox').forEach(function(cb) {
        cb.addEventListener('change', updateSelectedCount);
    });

    function updateSelectedCount() {
        const count = document.querySelectorAll('.product-checkbox:checked').length;
        document.getElementById('selectedCount').textContent = count;
        const panel = document.getElementById('bulkActionsPanel');
        if (count > 0) {
            panel.classList.remove('d-none');
        } else {
            panel.classList.add('d-none');
        }
    }

    document.getElementById('bulkActionsBtn').addEventListener('click', function() {
        document.getElementById('bulkActionsPanel').classList.toggle('d-none');
    });

    function deleteProduct(id) {
        if (!confirm('Видалити товар?')) return;

        fetch('/Admin/Admin/DeleteProduct', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ id: id })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message);
            }
        });
    }

    function bulkAction(action) {
        const checkboxes = document.querySelectorAll('.product-checkbox:checked');
        const ids = Array.from(checkboxes).map(cb => parseInt(cb.value));

        if (ids.length === 0) {
            alert('Оберіть товари');
            return;
        }

        if (!confirm(`Виконати дію "${action}" для ${ids.length} товарів?`)) return;

        fetch('/Admin/Admin/BulkAction', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ action: action, ids: ids })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message);
            }
        });
    }
</script>