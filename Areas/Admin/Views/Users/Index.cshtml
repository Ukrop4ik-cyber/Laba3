@model List<WebApplication2.Areas.Admin.Controllers.UserWithRolesViewModel>
@{
    ViewData["Title"] = "Користувачі";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

<div class="page-header mb-4">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1>Управління користувачами</h1>
            <p class="text-muted">Всього користувачів: @Model.Count</p>
        </div>
    </div>
</div>

<div class="table-card">
    <!-- Пошук -->
    <form method="get" class="row g-3 mb-4">
        <div class="col-md-8">
            <input type="text" name="search" class="form-control"
                   value="@ViewBag.Search" placeholder="Пошук за ім'ям, прізвищем або email...">
        </div>
        <div class="col-md-4">
            <button type="submit" class="btn btn-primary w-100">
                <i class="fas fa-search"></i> Шукати
            </button>
        </div>
    </form>

    <!-- Статистика -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="border rounded p-3 text-center">
                <h4 class="text-primary">@Model.Count</h4>
                <small class="text-muted">Всього користувачів</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="border rounded p-3 text-center">
                <h4 class="text-success">@Model.Count(u => u.Roles.Contains("Admin"))</h4>
                <small class="text-muted">Адміністраторів</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="border rounded p-3 text-center">
                <h4 class="text-info">@Model.Count(u => u.Roles.Contains("Manager"))</h4>
                <small class="text-muted">Менеджерів</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="border rounded p-3 text-center">
                <h4 class="text-danger">@Model.Count(u => u.IsLocked)</h4>
                <small class="text-muted">Заблоковано</small>
            </div>
        </div>
    </div>

    <!-- Таблиця -->
    <div class="table-responsive">
        <table class="table table-hover">
            <thead>
            <tr>
                <th>Користувач</th>
                <th>Email</th>
                <th>Телефон</th>
                <th>Ролі</th>
                <th>Замовлень</th>
                <th>Дата реєстрації</th>
                <th>Статус</th>
                <th>Дії</th>
            </tr>
            </thead>
            <tbody>
            @foreach (var item in Model)
            {
                <tr>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="user-avatar me-2"
                                 style="width: 40px; height: 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">
                                @item.User.FirstName.Substring(0, 1)@item.User.LastName.Substring(0, 1)
                            </div>
                            <div>
                                <strong>@item.User.FirstName @item.User.LastName</strong>
                            </div>
                        </div>
                    </td>
                    <td>@item.User.Email</td>
                    <td>@(item.User.PhoneNumber ?? "—")</td>
                    <td>
                        @foreach (var role in item.Roles)
                        {
                            @if (role == "Admin")
                            {
                                <span class="badge bg-danger me-1">@role</span>
                            }
                            else if (role == "Manager")
                            {
                                <span class="badge bg-warning me-1">@role</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary me-1">@role</span>
                            }
                        }
                        @if (!item.Roles.Any())
                        {
                            <span class="text-muted">—</span>
                        }
                    </td>
                    <td>
                        @if (item.OrderCount > 0)
                        {
                            <span class="badge bg-success">@item.OrderCount</span>
                        }
                        else
                        {
                            <span class="text-muted">0</span>
                        }
                    </td>
                    <td>@item.User.CreatedAt.ToString("dd.MM.yyyy")</td>
                    <td>
                        @if (item.IsLocked)
                        {
                            <span class="badge bg-danger">Заблоковано</span>
                        }
                        else
                        {
                            <span class="badge bg-success">Активний</span>
                        }
                    </td>
                    <td>
                        <div class="btn-group">
                            <button
                                onclick="quickRoleChange('@item.User.Id', '@item.User.FirstName @item.User.LastName')"
                                class="btn btn-sm btn-outline-warning" title="Швидка зміна ролей">
                                <i class="fas fa-bolt"></i>
                            </button>
                            @if (item.IsLocked)
                            {
                                <button onclick="unlockUser('@item.User.Id')"
                                        class="btn btn-sm btn-outline-success" title="Розблокувати">
                                    <i class="fas fa-unlock"></i>
                                </button>
                            }
                            else
                            {
                                <button onclick="lockUser('@item.User.Id')"
                                        class="btn btn-sm btn-outline-warning" title="Заблокувати">
                                    <i class="fas fa-lock"></i>
                                </button>
                            }
                            <button onclick="deleteUser('@item.User.Id')"
                                    class="btn btn-sm btn-outline-danger" title="Видалити">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            }
            </tbody>
        </table>
    </div>

    <!-- Пагінація -->
    @if (ViewBag.TotalPages > 1)
    {
        <nav class="mt-3">
            <ul class="pagination justify-content-center">
                @for (int i = 1; i <= ViewBag.TotalPages; i++)
                {
                    <li class="page-item @(i == ViewBag.CurrentPage ? "active" : "")">
                        <a class="page-link" href="?page=@i&search=@ViewBag.Search">@i</a>
                    </li>
                }
            </ul>
        </nav>
    }
</div>

@section Scripts {
    <script>
        function lockUser(userId) {
            if (!confirm('Заблокувати користувача?')) return;

            $.ajax({
                url: '/Admin/Users/Lock',
                method: 'POST',
                data: {id: userId},
                success: function (response) {
                    if (response.success) {
                        showToast(response.message, 'success');
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        showToast(response.message, 'danger');
                    }
                },
                error: function () {
                    showToast('Помилка з\'єднання', 'danger');
                }
            });
        }

        function unlockUser(userId) {
            if (!confirm('Розблокувати користувача?')) return;

            $.ajax({
                url: '/Admin/Users/Unlock',
                method: 'POST',
                data: {id: userId},
                success: function (response) {
                    if (response.success) {
                        showToast(response.message, 'success');
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        showToast(response.message, 'danger');
                    }
                },
                error: function () {
                    showToast('Помилка з\'єднання', 'danger');
                }
            });
        }

        function deleteUser(userId) {
            if (!confirm('Видалити користувача? Цю дію не можна відмінити.')) return;

            $.ajax({
                url: '/Admin/Users/Delete',
                method: 'POST',
                data: {id: userId},
                success: function (response) {
                    if (response.success) {
                        showToast(response.message, 'success');
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        showToast(response.message, 'danger');
                    }
                },
                error: function () {
                    showToast('Помилка з\'єднання', 'danger');
                }
            });
        }

        // Швидка зміна ролі
        function quickRoleChange(userId, userName) {
            // Показати модальне вікно з вибором ролей
            const modalHtml = `
        <div class="modal fade" id="quickRoleModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-user-tag"></i> Швидка зміна ролей
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p class="mb-3">Користувач: <strong>${userName}</strong></p>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="quickRoleAdmin">
                            <label class="form-check-label" for="quickRoleAdmin">
                                <i class="fas fa-crown text-danger"></i> Admin
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="quickRoleManager">
                            <label class="form-check-label" for="quickRoleManager">
                                <i class="fas fa-user-tie text-warning"></i> Manager
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="quickRoleUser">
                            <label class="form-check-label" for="quickRoleUser">
                                <i class="fas fa-user text-info"></i> User
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times"></i> Скасувати
                        </button>
                        <button type="button" class="btn btn-primary" onclick="saveQuickRoles('${userId}')">
                            <i class="fas fa-save"></i> Зберегти
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;

            // Видалити попереднє модальне вікно якщо є
            $('#quickRoleModal').remove();

            // Додати нове модальне вікно
            $('body').append(modalHtml);

            // Показати модальне вікно
            const modal = new bootstrap.Modal(document.getElementById('quickRoleModal'));
            modal.show();

            // Завантажити поточні ролі
            loadUserRoles(userId);
        }

        // Завантажити поточні ролі користувача
        function loadUserRoles(userId) {
            $.ajax({
                url: `/Admin/Users/GetUserRoles?userId=${userId}`,
                method: 'GET',
                success: function (roles) {
                    $('#quickRoleAdmin').prop('checked', roles.includes('Admin'));
                    $('#quickRoleManager').prop('checked', roles.includes('Manager'));
                    $('#quickRoleUser').prop('checked', roles.includes('User'));
                }
            });
        }

        // Зберегти швидкі ролі
        function saveQuickRoles(userId) {
            const roles = [];
            if ($('#quickRoleAdmin').is(':checked')) roles.push('Admin');
            if ($('#quickRoleManager').is(':checked')) roles.push('Manager');
            if ($('#quickRoleUser').is(':checked')) roles.push('User');

            if (roles.length === 0) {
                showToast('Оберіть хоча б одну роль', 'warning');
                return;
            }

            $.ajax({
                url: '/Admin/Users/QuickUpdateRoles',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({userId: userId, roles: roles}),
                success: function (response) {
                    if (response.success) {
                        showToast(response.message, 'success');
                        $('#quickRoleModal').modal('hide');
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        showToast(response.message, 'danger');
                    }
                },
                error: function () {
                    showToast('Помилка з\'єднання', 'danger');
                }
            });
        }
    </script>
}